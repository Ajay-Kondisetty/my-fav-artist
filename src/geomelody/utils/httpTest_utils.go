package utils

import (
	"errors"
	"fmt"
	"net/http"
	"net/http/httptest"
	"strings"
)

func (r *ExternalRequest) DoMock() (*http.Response, error) {
	apiNameSuffix := fmt.Sprintf("-%v", strings.ToLower(r.Name))
	mockType, ok := r.Headers[fmt.Sprintf("x-mock-api%v", apiNameSuffix)]
	if !ok {
		apiNameSuffix = ""
		mockType = r.Headers["x-mock-api"]
	}

	var rr = httptest.NewRecorder()

	var err error

	switch mockType {
	case "error_response":
		rr.WriteHeader(400)
		_, _ = rr.WriteString(`{"errors":"some error"}`)
	default:
		switch r.Name {
		case "GetTopTrackByCountry":
			rr.WriteHeader(200)
			_, _ = rr.WriteString(`{"tracks":{"track":[{"name":"Yellow","duration":"267","listeners":"2531979","mbid":"8b5bf478-22f8-4902-a1c1-0db82261db58","url":"https://www.last.fm/music/Coldplay/_/Yellow","streamable":{"#text":"0","fulltrack":"0"},"artist":{"name":"Coldplay","mbid":"cc197bad-dc9c-440d-a5b5-d52ba2e14234","url":"https://www.last.fm/music/Coldplay"},"image":[{"#text":"https://lastfm.freetls.fastly.net/i/u/34s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"small"},{"#text":"https://lastfm.freetls.fastly.net/i/u/64s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"medium"},{"#text":"https://lastfm.freetls.fastly.net/i/u/174s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"large"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"extralarge"}],"@attr":{"rank":"0"}}],"@attr":{"country":"India","page":"1","perPage":"1","totalPages":"3499191","total":"3499191"}}}`)
		case "GetArtistInfo":
			rr.WriteHeader(200)
			_, _ = rr.WriteString(`{"artist":{"name":"Coldplay","mbid":"cc197bad-dc9c-440d-a5b5-d52ba2e14234","url":"https://www.last.fm/music/Coldplay","image":[{"#text":"https://lastfm.freetls.fastly.net/i/u/34s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"small"},{"#text":"https://lastfm.freetls.fastly.net/i/u/64s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"medium"},{"#text":"https://lastfm.freetls.fastly.net/i/u/174s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"large"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"extralarge"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"mega"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":""}],"streamable":"0","ontour":"0","stats":{"listeners":"7296979","playcount":"554561574"},"similar":{"artist":[{"name":"Keane","url":"https://www.last.fm/music/Keane","image":[{"#text":"https://lastfm.freetls.fastly.net/i/u/34s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"small"},{"#text":"https://lastfm.freetls.fastly.net/i/u/64s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"medium"},{"#text":"https://lastfm.freetls.fastly.net/i/u/174s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"large"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"extralarge"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"mega"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":""}]},{"name":"Imagine Dragons","url":"https://www.last.fm/music/Imagine+Dragons","image":[{"#text":"https://lastfm.freetls.fastly.net/i/u/34s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"small"},{"#text":"https://lastfm.freetls.fastly.net/i/u/64s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"medium"},{"#text":"https://lastfm.freetls.fastly.net/i/u/174s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"large"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"extralarge"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"mega"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":""}]},{"name":"OneRepublic","url":"https://www.last.fm/music/OneRepublic","image":[{"#text":"https://lastfm.freetls.fastly.net/i/u/34s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"small"},{"#text":"https://lastfm.freetls.fastly.net/i/u/64s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"medium"},{"#text":"https://lastfm.freetls.fastly.net/i/u/174s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"large"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"extralarge"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"mega"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":""}]},{"name":"Travis","url":"https://www.last.fm/music/Travis","image":[{"#text":"https://lastfm.freetls.fastly.net/i/u/34s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"small"},{"#text":"https://lastfm.freetls.fastly.net/i/u/64s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"medium"},{"#text":"https://lastfm.freetls.fastly.net/i/u/174s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"large"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"extralarge"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"mega"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":""}]},{"name":"Snow Patrol","url":"https://www.last.fm/music/Snow+Patrol","image":[{"#text":"https://lastfm.freetls.fastly.net/i/u/34s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"small"},{"#text":"https://lastfm.freetls.fastly.net/i/u/64s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"medium"},{"#text":"https://lastfm.freetls.fastly.net/i/u/174s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"large"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"extralarge"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"mega"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":""}]}]},"tags":{"tag":[{"name":"rock","url":"https://www.last.fm/tag/rock"},{"name":"alternative","url":"https://www.last.fm/tag/alternative"},{"name":"britpop","url":"https://www.last.fm/tag/britpop"},{"name":"alternative rock","url":"https://www.last.fm/tag/alternative+rock"},{"name":"indie","url":"https://www.last.fm/tag/indie"}]},"bio":{"links":{"link":{"#text":"","rel":"original","href":"https://last.fm/music/Coldplay/+wiki"}},"published":"02 Feb 2006, 02:58","summary":"Coldplay is a British alternative rock and britpop band formed in London in 1997. They consist of vocalist and pianist Chris Martin, guitarist Jonny Buckland, bassist Guy Berryman, drummer Will Champion and creative director Phil Harvey. They met at University College London and began playing music together from 1996 to 1998, initially calling themselves Starfish. Coldplay's music incorporates elements of soft rock, pop rock, piano rock, and post-britpop. <a href=\"https://www.last.fm/music/Coldplay\">Read more on Last.fm</a>","content":"Coldplay is a British alternative rock and britpop band formed in London in 1997. They consist of vocalist and pianist Chris Martin, guitarist Jonny Buckland, bassist Guy Berryman, drummer Will Champion and creative director Phil Harvey. They met at University College London and began playing music together from 1996 to 1998, initially calling themselves Starfish. Coldplay's music incorporates elements of soft rock, pop rock, piano rock, and post-britpop.\n\nAfter independently releasing an extended play, Safety (1998), Coldplay signed with Parlophone in 1999. The band's debut album, Parachutes (2000), included their breakthrough single \"Yellow\" and received a Brit Award for British Album of the Year, a Grammy Award for Best Alternative Music Album and a Mercury Prize nomination. Their second album, A Rush of Blood to the Head (2002), won the same accolades and included \"Clocks\", which earned a Grammy Award for Record of the Year. In 2005, they released X&Y; the album was marked by a troubled production and various delays, completing what the band considered a trilogy as well. Coldplay's fourth effort, Viva la Vida or Death and All His Friends (2008), received a Grammy Award for Best Rock Album and their first Album of the Year nomination, while its title track was the first British group song to reach number-one in the United Kingdom and United States simultaneously in the 21st century. Both X&Y and Viva la Vida were the best-selling albums of their respective years, topping the charts in more than 30 countries each.\n\nSince then, Coldplay further diversified their sound with the subsequent releases Mylo Xyloto (2011), Ghost Stories (2014), A Head Full of Dreams (2015), Everyday Life (2019) and Music of the Spheres (2021). Each album presented a unique theme and added new musical styles to the band's original repertoire, including electronica, ambient, pop, R&B, funk, classical, jazz fusion, and progressive rock. They are also known for \"euphoric\" live performances, which NME said are when the band \"come alive and make the most sense\". To celebrate their 20th anniversary in 2018, a career-spanning documentary directed by Mat Whitecross was premiered at selected cinemas, featuring previously unseen behind-the-scenes footage.\n\nWith 100 million albums sold worldwide, Coldplay are the most successful band of the 21st century and one of the best-selling music acts of all time. According to Fuse, they are also the sixth-most awarded group in history. Other notable achievements include the seventh-highest-grossing tour of all time, three of the 50 highest-selling albums ever in the United Kingdom, the most number-one records in the country without ever missing the top, most nominations and wins for a band in Brit Awards history, and becoming the first British group to debut at number-one on the Billboard Hot 100. Coldplay are considered one of the most influential bands of the 21st century as well, with Forbes describing them as the standard for the current alternative scene. The Rock and Roll Hall of Fame included A Rush of Blood to the Head on their \"200 Definitive Albums\" list and the single \"Yellow\" is part of their \"Songs That Shaped Rock and Roll\" exhibition for being one of the most successful and important recordings in the industry. In spite of their popularity and impact, Coldplay have earned a reputation as polarizing music icons.\n\nFull Wikipedia article: https://en.wikipedia.org/wiki/Coldplay\n\nStudio albums\nParachutes (2000)\nA Rush of Blood to the Head (2002)\nX&Y (2005)\nViva la Vida or Death and All His Friends (2008)\nMylo Xyloto (2011)\nGhost Stories (2014)\nA Head Full of Dreams (2015)\nEveryday Life (2019)\nMusic of the Spheres (2021) <a href=\"https://www.last.fm/music/Coldplay\">Read more on Last.fm</a>. User-contributed text is available under the Creative Commons By-SA License; additional terms may apply."}}}`)
		case "GetTrackID":
			rr.WriteHeader(200)
			_, _ = rr.WriteString(`{"message":{"header":{"status_code":200,"execute_time":0.097953081130981,"available":11},"body":{"track_list":[{"track":{"track_id":51074845,"track_name":"Yellow","track_name_translation_list":[],"track_rating":1,"commontrack_id":23924349,"instrumental":0,"explicit":0,"has_lyrics":0,"has_subtitles":0,"has_richsync":0,"num_favourite":0,"album_id":16855216,"album_name":"Pickin' On Coldplay - A Bluegrass Tribute","artist_id":26293933,"artist_name":"Pickin' On Coldplay","track_share_url":"https:\/\/www.musixmatch.com\/lyrics\/Pickin-On-Coldplay\/Yellow?utm_source=application&utm_campaign=api&utm_medium=Altimetrik%3A1409624248346","track_edit_url":"https:\/\/www.musixmatch.com\/lyrics\/Pickin-On-Coldplay\/Yellow\/edit?utm_source=application&utm_campaign=api&utm_medium=Altimetrik%3A1409624248346","restricted":0,"updated_time":"2014-01-26T10:27:17Z","primary_genres":{"music_genre_list":[{"music_genre":{"music_genre_id":6,"music_genre_parent_id":34,"music_genre_name":"Country","music_genre_name_extended":"Country","music_genre_vanity":"Country"}}]}}}]}}}`)
		case "GetTrackLyrics":
			rr.WriteHeader(200)
			_, _ = rr.WriteString(`{"message":{"header":{"status_code":200,"execute_time":0.72923994064331,"available":10000},"body":{"track_list":[{"track":{"track_id":118228581,"track_name":"In the Playgroundz","track_name_translation_list":[],"track_rating":1,"commontrack_id":65370284,"instrumental":0,"explicit":1,"has_lyrics":0,"has_subtitles":0,"has_richsync":0,"num_favourite":0,"album_id":24426665,"album_name":"Thee Inevitable","artist_id":31972889,"artist_name":"Nok-Out feat. D.Stitt","track_share_url":"https:\/\/www.musixmatch.com\/lyrics\/Nok-Out-feat-D-Stitt\/In-the-Playgroundz-feat-D-Stitt?utm_source=application&utm_campaign=api&utm_medium=Altimetrik%3A1409624248346","track_edit_url":"https:\/\/www.musixmatch.com\/lyrics\/Nok-Out-feat-D-Stitt\/In-the-Playgroundz-feat-D-Stitt\/edit?utm_source=application&utm_campaign=api&utm_medium=Altimetrik%3A1409624248346","restricted":0,"updated_time":"2016-11-17T20:06:10Z","primary_genres":{"music_genre_list":[]}}}]}}}`)
		case "GetTrackSuggestions":
			rr.WriteHeader(200)
			_, _ = rr.WriteString(`{"similartracks":{"track":[{"name":"The Scientist","playcount":20959436,"mbid":"13f5488d-8e41-42d8-9fe9-a5295f1a9a3d","match":1.0,"url":"https://www.last.fm/music/Coldplay/_/The+Scientist","streamable":{"#text":"0","fulltrack":"0"},"duration":309,"artist":{"name":"Coldplay","mbid":"cc197bad-dc9c-440d-a5b5-d52ba2e14234","url":"https://www.last.fm/music/Coldplay"},"image":[{"#text":"https://lastfm.freetls.fastly.net/i/u/34s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"small"},{"#text":"https://lastfm.freetls.fastly.net/i/u/64s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"medium"},{"#text":"https://lastfm.freetls.fastly.net/i/u/174s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"large"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"extralarge"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"mega"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":""}]},{"name":"Sparks","playcount":16814271,"mbid":"d99ffc1f-9819-4db1-8677-b13e298bd425","match":0.962653,"url":"https://www.last.fm/music/Coldplay/_/Sparks","streamable":{"#text":"0","fulltrack":"0"},"duration":269,"artist":{"name":"Coldplay","mbid":"cc197bad-dc9c-440d-a5b5-d52ba2e14234","url":"https://www.last.fm/music/Coldplay"},"image":[{"#text":"https://lastfm.freetls.fastly.net/i/u/34s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"small"},{"#text":"https://lastfm.freetls.fastly.net/i/u/64s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"medium"},{"#text":"https://lastfm.freetls.fastly.net/i/u/174s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"large"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"extralarge"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"mega"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":""}]},{"name":"Somewhere Only We Know","playcount":15265085,"mbid":"0868857f-740f-47c1-a2c7-b6323c185c63","match":0.567258,"url":"https://www.last.fm/music/Keane/_/Somewhere+Only+We+Know","streamable":{"#text":"0","fulltrack":"0"},"duration":234,"artist":{"name":"Keane","mbid":"c7020c6d-cae9-4db3-92a7-e5c561cbad50","url":"https://www.last.fm/music/Keane"},"image":[{"#text":"https://lastfm.freetls.fastly.net/i/u/34s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"small"},{"#text":"https://lastfm.freetls.fastly.net/i/u/64s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"medium"},{"#text":"https://lastfm.freetls.fastly.net/i/u/174s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"large"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"extralarge"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"mega"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":""}]},{"name":"Chasing Cars","playcount":15387887,"mbid":"f62a3798-6559-4f9b-8b80-6ea3e4ad89aa","match":0.396943,"url":"https://www.last.fm/music/Snow+Patrol/_/Chasing+Cars","streamable":{"#text":"0","fulltrack":"0"},"duration":0,"artist":{"name":"Snow Patrol","mbid":"a66999a7-ae5c-460e-ba94-1a01143ae847","url":"https://www.last.fm/music/Snow+Patrol"},"image":[{"#text":"https://lastfm.freetls.fastly.net/i/u/34s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"small"},{"#text":"https://lastfm.freetls.fastly.net/i/u/64s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"medium"},{"#text":"https://lastfm.freetls.fastly.net/i/u/174s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"large"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"extralarge"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"mega"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":""}]},{"name":"Iris","playcount":10365653,"mbid":"57d079a0-a195-453e-bb01-9ccff26a5de2","match":0.394981,"url":"https://www.last.fm/music/Goo+Goo+Dolls/_/Iris","streamable":{"#text":"0","fulltrack":"0"},"duration":289,"artist":{"name":"Goo Goo Dolls","mbid":"e2c00c56-8365-4160-9f40-a64682917633","url":"https://www.last.fm/music/Goo+Goo+Dolls"},"image":[{"#text":"https://lastfm.freetls.fastly.net/i/u/34s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"small"},{"#text":"https://lastfm.freetls.fastly.net/i/u/64s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"medium"},{"#text":"https://lastfm.freetls.fastly.net/i/u/174s/2a96cbd8b46e442fc41c2b86b821562f.png","size":"large"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"extralarge"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":"mega"},{"#text":"https://lastfm.freetls.fastly.net/i/u/300x300/2a96cbd8b46e442fc41c2b86b821562f.png","size":""}]}],"@attr":{"artist":"Coldplay"}}}`)
		default:
			err = errors.New("No matching API found")
		}
	}

	return rr.Result(), err
}

// GetMockHeadersFromContext fetches mock headers from request context and add it to the request headers.
func (r *ExternalRequest) GetMockHeadersFromContext() {
	if r.ReqCtx == nil {
		return
	}

	mockHeaders, ok := r.ReqCtx.Value(fmt.Sprintf("x-mock-headers-%v", strings.ToLower(r.Name))).(map[string]string)
	if !ok {
		mockHeaders, _ = r.ReqCtx.Value("x-mock-headers").(map[string]string)
	}
	if len(mockHeaders) <= 0 {
		return
	}

	for k, v := range mockHeaders {
		r.Headers[k] = v
	}
}
